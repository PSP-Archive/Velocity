<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vLib: image.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<h1>image.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Velocity  v1.5</span>
<a name="l00004"></a>00004 <span class="comment">  Copyright 2006, 2007 Gabriel Anderson</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment">    it under the terms of the GNU General Public License as published by</span>
<a name="l00008"></a>00008 <span class="comment">    the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00009"></a>00009 <span class="comment">    (at your option) any later version.</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">    This program is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00014"></a>00014 <span class="comment">    GNU General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">    You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment">    along with this program; if not, write to the Free Software</span>
<a name="l00018"></a>00018 <span class="comment">    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">*/</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="comment">//---------------------------------------------------------------------------------//</span>
<a name="l00023"></a>00023 <span class="comment">// Includes                                                                        //</span>
<a name="l00024"></a>00024 <span class="comment">//---------------------------------------------------------------------------------//</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "vlib.h"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">//---------------------------------------------------------------------------------//</span>
<a name="l00029"></a>00029 <span class="comment">// Image                                                                           //</span>
<a name="l00030"></a>00030 <span class="comment">//---------------------------------------------------------------------------------//</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="keyword">static</span> <span class="keywordtype">int</span> getPow2 ( <span class="keywordtype">int</span> value ) {
<a name="l00033"></a>00033   <span class="keywordtype">int</span> b = value;
<a name="l00034"></a>00034   <span class="keywordtype">int</span> n;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036   <span class="keywordflow">for</span> ( n = 0; b != 0; n++ )
<a name="l00037"></a>00037     b &gt;&gt;= 1;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039   b = 1 &lt;&lt; n;
<a name="l00040"></a>00040 
<a name="l00041"></a>00041   <span class="keywordflow">if</span> ( b == 2 * value )
<a name="l00042"></a>00042     b &gt;&gt;= 1;
<a name="l00043"></a>00043 
<a name="l00044"></a>00044   <span class="keywordflow">return</span> b;
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">static</span> <span class="keywordtype">void</span> load_png ( <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <a class="code" href="a00023.html">Image</a> *img ) {
<a name="l00048"></a>00048   <span class="comment">// open the image file</span>
<a name="l00049"></a>00049   FILE *fp;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   <span class="keywordflow">if</span> ( ( fp = fopen ( filename, <span class="stringliteral">"rb"</span> ) ) == NULL )
<a name="l00052"></a>00052     <span class="keywordflow">return</span>;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054   png_structp png_ptr;
<a name="l00055"></a>00055   png_infop info_ptr;
<a name="l00056"></a>00056   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sig_read = 0;
<a name="l00057"></a>00057   png_uint_32 width, height;
<a name="l00058"></a>00058   <span class="keywordtype">int</span> bit_depth, color_type, interlace_type, x, y;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060   png_ptr = png_create_read_struct ( PNG_LIBPNG_VER_STRING, NULL, NULL, NULL );
<a name="l00061"></a>00061   info_ptr = png_create_info_struct ( png_ptr );
<a name="l00062"></a>00062   png_init_io ( png_ptr, fp );
<a name="l00063"></a>00063   png_set_sig_bytes ( png_ptr, sig_read );
<a name="l00064"></a>00064   png_read_info ( png_ptr, info_ptr );
<a name="l00065"></a>00065   png_get_IHDR ( png_ptr, info_ptr, &amp;width, &amp;height, &amp;bit_depth, &amp;color_type, &amp;interlace_type, int_p_NULL, int_p_NULL );
<a name="l00066"></a>00066 
<a name="l00067"></a>00067   img-&gt;<a class="code" href="a00023_36f406959a34f391746e66bb8ee3e334.html#36f406959a34f391746e66bb8ee3e334">initWidth</a> = width;
<a name="l00068"></a>00068   img-&gt;<a class="code" href="a00023_872de85785e03050a81a5c01e0ddd4a0.html#872de85785e03050a81a5c01e0ddd4a0">initHeight</a> = height;
<a name="l00069"></a>00069   img-&gt;<a class="code" href="a00023_27ec986c52261757ad7e8a027b7154be.html#27ec986c52261757ad7e8a027b7154be">width</a> = width;
<a name="l00070"></a>00070   img-&gt;<a class="code" href="a00023_d31f0d5dbf799da956b02123572e9920.html#d31f0d5dbf799da956b02123572e9920">height</a> = height;
<a name="l00071"></a>00071   img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a> = getPow2 ( width );
<a name="l00072"></a>00072   img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a> = getPow2 ( height );
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> = img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a> * img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a> * <span class="keyword">sizeof</span> ( u32 );
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   png_set_strip_16 ( png_ptr );
<a name="l00077"></a>00077   png_set_packing ( png_ptr );
<a name="l00078"></a>00078 
<a name="l00079"></a>00079   <span class="keywordflow">if</span> ( color_type == PNG_COLOR_TYPE_PALETTE )
<a name="l00080"></a>00080     png_set_palette_to_rgb ( png_ptr );
<a name="l00081"></a>00081 
<a name="l00082"></a>00082   <span class="keywordflow">if</span> ( color_type == PNG_COLOR_TYPE_GRAY &amp;&amp; bit_depth &lt; 8 )
<a name="l00083"></a>00083     png_set_gray_1_2_4_to_8 ( png_ptr );
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   <span class="keywordflow">if</span> ( png_get_valid ( png_ptr, info_ptr, PNG_INFO_tRNS ) )
<a name="l00086"></a>00086     png_set_tRNS_to_alpha ( png_ptr );
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   png_set_filler ( png_ptr, 0xff, PNG_FILLER_AFTER );
<a name="l00089"></a>00089 
<a name="l00090"></a>00090   img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> = ( u32* ) malloc ( img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> );
<a name="l00091"></a>00091 
<a name="l00092"></a>00092   u32* line = ( u32* ) malloc ( width * 4 );
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   <span class="keywordflow">for</span> ( y = 0; y &lt; ( int ) height; y++ ) {
<a name="l00095"></a>00095     png_read_row ( png_ptr, ( u8* ) line, png_bytep_NULL );
<a name="l00096"></a>00096     <span class="keywordflow">for</span> ( x = 0; x &lt; ( int ) width; x++ ) {
<a name="l00097"></a>00097       u32 color = line[x];
<a name="l00098"></a>00098       img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>[x + y * ( int ) img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a>] =  color;
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100   }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102   free ( line );
<a name="l00103"></a>00103 
<a name="l00104"></a>00104   png_read_end ( png_ptr, info_ptr );
<a name="l00105"></a>00105   png_destroy_read_struct ( &amp;png_ptr, &amp;info_ptr, png_infopp_NULL );
<a name="l00106"></a>00106 
<a name="l00107"></a>00107   <span class="comment">// close the file</span>
<a name="l00108"></a>00108   fclose ( fp );
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">// xart's png loader. It's not working atm (probably due to variable type issues), but once I get it working</span>
<a name="l00112"></a>00112 <span class="comment">//I'll do a head to head comparison between this and my current png loader to see which one can load the quickest.</span>
<a name="l00113"></a>00113 <span class="comment">/*static void loadPNG(const char *filename, Image *img)</span>
<a name="l00114"></a>00114 <span class="comment">{</span>
<a name="l00115"></a>00115 <span class="comment">  Image *img = (Image*) malloc(sizeof(Image));</span>
<a name="l00116"></a>00116 <span class="comment">  img-&gt;location = location;</span>
<a name="l00117"></a>00117 <span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">  int number_passes, pass;</span>
<a name="l00119"></a>00119 <span class="comment">  png_structp png_ptr;</span>
<a name="l00120"></a>00120 <span class="comment">  png_infop info_ptr;</span>
<a name="l00121"></a>00121 <span class="comment">  unsigned int sig_read = 0;</span>
<a name="l00122"></a>00122 <span class="comment">  png_uint_32 width, height;</span>
<a name="l00123"></a>00123 <span class="comment">  int bit_depth, color_type, interlace_type, x, y;</span>
<a name="l00124"></a>00124 <span class="comment">  u32* line;</span>
<a name="l00125"></a>00125 <span class="comment">  FILE *fp;</span>
<a name="l00126"></a>00126 <span class="comment"></span>
<a name="l00127"></a>00127 <span class="comment">  if((fp = fopen(filename, "rb")) == NULL)</span>
<a name="l00128"></a>00128 <span class="comment">    return NULL;</span>
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">  fseek(fp,0,SEEK_SET);</span>
<a name="l00131"></a>00131 <span class="comment"></span>
<a name="l00132"></a>00132 <span class="comment">  png_ptr = png_create_read_struct(PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);</span>
<a name="l00133"></a>00133 <span class="comment">  if (png_ptr == NULL)</span>
<a name="l00134"></a>00134 <span class="comment">  {</span>
<a name="l00135"></a>00135 <span class="comment">    fclose(fp);</span>
<a name="l00136"></a>00136 <span class="comment">    return NULL;</span>
<a name="l00137"></a>00137 <span class="comment">  }</span>
<a name="l00138"></a>00138 <span class="comment"></span>
<a name="l00139"></a>00139 <span class="comment">  // Optinal error function currently not used in this class</span>
<a name="l00140"></a>00140 <span class="comment">  //png_set_error_fn(png_ptr, (png_voidp) NULL, (png_error_ptr) NULL, user_warning_fn);</span>
<a name="l00141"></a>00141 <span class="comment">  info_ptr = png_create_info_struct(png_ptr);</span>
<a name="l00142"></a>00142 <span class="comment">  if (info_ptr == NULL)</span>
<a name="l00143"></a>00143 <span class="comment">  {</span>
<a name="l00144"></a>00144 <span class="comment">    fclose(fp);</span>
<a name="l00145"></a>00145 <span class="comment">    png_destroy_read_struct(&amp;png_ptr, png_infopp_NULL, png_infopp_NULL);</span>
<a name="l00146"></a>00146 <span class="comment">    return NULL;</span>
<a name="l00147"></a>00147 <span class="comment">  }</span>
<a name="l00148"></a>00148 <span class="comment"></span>
<a name="l00149"></a>00149 <span class="comment">  png_init_io(png_ptr, fp);</span>
<a name="l00150"></a>00150 <span class="comment">  png_set_sig_bytes(png_ptr, sig_read);</span>
<a name="l00151"></a>00151 <span class="comment">  png_read_info(png_ptr, info_ptr);</span>
<a name="l00152"></a>00152 <span class="comment">  png_get_IHDR(png_ptr, info_ptr, &amp;width, &amp;height, &amp;bit_depth, &amp;color_type, &amp;interlace_type, int_p_NULL, int_p_NULL);</span>
<a name="l00153"></a>00153 <span class="comment"></span>
<a name="l00154"></a>00154 <span class="comment">  if (width &gt; 512 || height &gt; 512)</span>
<a name="l00155"></a>00155 <span class="comment">  {</span>
<a name="l00156"></a>00156 <span class="comment">    fclose(fp);</span>
<a name="l00157"></a>00157 <span class="comment">    png_destroy_read_struct(&amp;png_ptr, png_infopp_NULL, png_infopp_NULL);</span>
<a name="l00158"></a>00158 <span class="comment">    return NULL;</span>
<a name="l00159"></a>00159 <span class="comment">  }</span>
<a name="l00160"></a>00160 <span class="comment"></span>
<a name="l00161"></a>00161 <span class="comment">  img-&gt;width = width;</span>
<a name="l00162"></a>00162 <span class="comment">  img-&gt;height = height;</span>
<a name="l00163"></a>00163 <span class="comment">  img-&gt;initWidth = width;</span>
<a name="l00164"></a>00164 <span class="comment">  img-&gt;initHeight = height;</span>
<a name="l00165"></a>00165 <span class="comment">  img-&gt;realWidth = getPow2(width);</span>
<a name="l00166"></a>00166 <span class="comment">  img-&gt;realHeight = getPow2(height);</span>
<a name="l00167"></a>00167 <span class="comment"></span>
<a name="l00168"></a>00168 <span class="comment">  // New (the check) - Convert 16-bits per colour component to 8-bits per colour component.</span>
<a name="l00169"></a>00169 <span class="comment">  if (bit_depth == 16) png_set_strip_16(png_ptr);</span>
<a name="l00170"></a>00170 <span class="comment"></span>
<a name="l00171"></a>00171 <span class="comment">  // Extract multiple pixels with bit depths of 1, 2, and 4 from a single</span>
<a name="l00172"></a>00172 <span class="comment">  // byte into separate bytes (useful for paletted and grayscale images).</span>
<a name="l00173"></a>00173 <span class="comment">  png_set_packing(png_ptr);</span>
<a name="l00174"></a>00174 <span class="comment"></span>
<a name="l00175"></a>00175 <span class="comment">  if (color_type == PNG_COLOR_TYPE_PALETTE)</span>
<a name="l00176"></a>00176 <span class="comment">    png_set_palette_to_rgb(png_ptr);</span>
<a name="l00177"></a>00177 <span class="comment"></span>
<a name="l00178"></a>00178 <span class="comment">  // New - Convert grayscale to RGB triplets</span>
<a name="l00179"></a>00179 <span class="comment">  if ((color_type == PNG_COLOR_TYPE_GRAY) || (color_type == PNG_COLOR_TYPE_GRAY_ALPHA))</span>
<a name="l00180"></a>00180 <span class="comment">    png_set_gray_to_rgb(png_ptr);</span>
<a name="l00181"></a>00181 <span class="comment"></span>
<a name="l00182"></a>00182 <span class="comment">  if (color_type == PNG_COLOR_TYPE_GRAY &amp;&amp; bit_depth &lt; 8)</span>
<a name="l00183"></a>00183 <span class="comment">    png_set_gray_1_2_4_to_8(png_ptr);</span>
<a name="l00184"></a>00184 <span class="comment"></span>
<a name="l00185"></a>00185 <span class="comment">  if (png_get_valid(png_ptr, info_ptr, PNG_INFO_tRNS))</span>
<a name="l00186"></a>00186 <span class="comment">    png_set_tRNS_to_alpha(png_ptr);</span>
<a name="l00187"></a>00187 <span class="comment"></span>
<a name="l00188"></a>00188 <span class="comment">  png_set_filler(png_ptr, 0xff, PNG_FILLER_AFTER);</span>
<a name="l00189"></a>00189 <span class="comment"></span>
<a name="l00190"></a>00190 <span class="comment">  u32 *data = (u32 *) memalign(16, img-&gt;width * img-&gt;height * sizeof(u32));</span>
<a name="l00191"></a>00191 <span class="comment"></span>
<a name="l00192"></a>00192 <span class="comment">  if (!data)</span>
<a name="l00193"></a>00193 <span class="comment">  {</span>
<a name="l00194"></a>00194 <span class="comment">    fclose(fp);</span>
<a name="l00195"></a>00195 <span class="comment">    png_destroy_read_struct(&amp;png_ptr, png_infopp_NULL, png_infopp_NULL);</span>
<a name="l00196"></a>00196 <span class="comment">    return NULL;</span>
<a name="l00197"></a>00197 <span class="comment">  }</span>
<a name="l00198"></a>00198 <span class="comment"></span>
<a name="l00199"></a>00199 <span class="comment">  line = (u32*) malloc(width * 4);</span>
<a name="l00200"></a>00200 <span class="comment">  if (!line)</span>
<a name="l00201"></a>00201 <span class="comment">  {</span>
<a name="l00202"></a>00202 <span class="comment">    free(data);</span>
<a name="l00203"></a>00203 <span class="comment">    fclose(fp);</span>
<a name="l00204"></a>00204 <span class="comment">    png_destroy_read_struct(&amp;png_ptr, png_infopp_NULL, png_infopp_NULL);</span>
<a name="l00205"></a>00205 <span class="comment">    return NULL;</span>
<a name="l00206"></a>00206 <span class="comment">  }</span>
<a name="l00207"></a>00207 <span class="comment"></span>
<a name="l00208"></a>00208 <span class="comment">  // New - Turn on interlace handling.</span>
<a name="l00209"></a>00209 <span class="comment">  number_passes = png_set_interlace_handling(png_ptr);</span>
<a name="l00210"></a>00210 <span class="comment"></span>
<a name="l00211"></a>00211 <span class="comment">  // New - Call to gamma correct and add the background to the palette</span>
<a name="l00212"></a>00212 <span class="comment">  // and update info structure.</span>
<a name="l00213"></a>00213 <span class="comment">  png_read_update_info(png_ptr, info_ptr);</span>
<a name="l00214"></a>00214 <span class="comment"></span>
<a name="l00215"></a>00215 <span class="comment">  // New - Read the image, one line at a line (easier to debug!)</span>
<a name="l00216"></a>00216 <span class="comment">  for (pass = 0; pass &lt; number_passes; pass++) {</span>
<a name="l00217"></a>00217 <span class="comment">      for (y = 0; y &lt; (int)height; y++)</span>
<a name="l00218"></a>00218 <span class="comment">      {</span>
<a name="l00219"></a>00219 <span class="comment">         png_read_row(png_ptr, (u8*) line, png_bytep_NULL);</span>
<a name="l00220"></a>00220 <span class="comment"></span>
<a name="l00221"></a>00221 <span class="comment">         for (x = 0; x &lt; (int)width; x++)</span>
<a name="l00222"></a>00222 <span class="comment">         {</span>
<a name="l00223"></a>00223 <span class="comment">            u32 color = line[x];</span>
<a name="l00224"></a>00224 <span class="comment">            data[x + y * (int)img-&gt;width] = color;</span>
<a name="l00225"></a>00225 <span class="comment">         }</span>
<a name="l00226"></a>00226 <span class="comment">      }</span>
<a name="l00227"></a>00227 <span class="comment">  }</span>
<a name="l00228"></a>00228 <span class="comment">  free(line);</span>
<a name="l00229"></a>00229 <span class="comment"></span>
<a name="l00230"></a>00230 <span class="comment">  png_read_end(png_ptr, info_ptr);</span>
<a name="l00231"></a>00231 <span class="comment">  png_destroy_read_struct(&amp;png_ptr, &amp;info_ptr, png_infopp_NULL);</span>
<a name="l00232"></a>00232 <span class="comment">  fclose(fp);</span>
<a name="l00233"></a>00233 <span class="comment">  img-&gt;data=(u32*)data;</span>
<a name="l00234"></a>00234 <span class="comment"></span>
<a name="l00235"></a>00235 <span class="comment">  return img;</span>
<a name="l00236"></a>00236 <span class="comment">} */</span>
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="comment">// Works, but needs to check file headers to see whether or not it should</span>
<a name="l00239"></a>00239 <span class="comment">//flip/invert the image's pixels.</span>
<a name="l00240"></a>00240 <span class="keyword">static</span> <span class="keywordtype">void</span> load_tga ( <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <a class="code" href="a00023.html">Image</a> *img ) {
<a name="l00241"></a>00241   <span class="comment">// open the image file</span>
<a name="l00242"></a>00242   FILE *fp;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <span class="keywordflow">if</span> ( ( fp = fopen ( filename, <span class="stringliteral">"rb"</span> ) ) == NULL )
<a name="l00245"></a>00245     <span class="keywordflow">return</span>;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ucharBad; <span class="comment">// garbage data</span>
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <span class="keywordtype">short</span> <span class="keywordtype">int</span> sintBad;    <span class="comment">// garbage data</span>
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   <span class="keywordtype">int</span> colorMode;      <span class="comment">// 4 for RGBA, 3 for RGB</span>
<a name="l00252"></a>00252 
<a name="l00253"></a>00253   <span class="keywordtype">long</span> imageIdx;      <span class="comment">// counter variable</span>
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> colorSwap;  <span class="comment">// swap variable</span>
<a name="l00256"></a>00256 
<a name="l00257"></a>00257   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> imageTypeCode;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bitCount;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261   <span class="comment">// read first two bytes of garbage</span>
<a name="l00262"></a>00262   fread ( &amp;ucharBad, <span class="keyword">sizeof</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ), 1, fp );
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   fread ( &amp;ucharBad, <span class="keyword">sizeof</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ), 1, fp );
<a name="l00265"></a>00265 
<a name="l00266"></a>00266   <span class="comment">// read in the image type</span>
<a name="l00267"></a>00267   fread ( &amp;imageTypeCode, <span class="keyword">sizeof</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ), 1, fp );
<a name="l00268"></a>00268 
<a name="l00269"></a>00269   <span class="comment">// for our purposes, the image type should be either a 2 or a 3</span>
<a name="l00270"></a>00270   <span class="keywordflow">if</span> ( ( imageTypeCode != 2 ) &amp;&amp; ( imageTypeCode != 3 ) ) {
<a name="l00271"></a>00271     fclose ( fp );
<a name="l00272"></a>00272     <span class="keywordflow">return</span>;
<a name="l00273"></a>00273   }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275   <span class="comment">// read 13 bytes of garbage data</span>
<a name="l00276"></a>00276   fread ( &amp;sintBad, <span class="keyword">sizeof</span> ( <span class="keywordtype">short</span> <span class="keywordtype">int</span> ), 1, fp );
<a name="l00277"></a>00277 
<a name="l00278"></a>00278   fread ( &amp;sintBad, <span class="keyword">sizeof</span> ( <span class="keywordtype">short</span> <span class="keywordtype">int</span> ), 1, fp );
<a name="l00279"></a>00279 
<a name="l00280"></a>00280   fread ( &amp;ucharBad, <span class="keyword">sizeof</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ), 1, fp );
<a name="l00281"></a>00281 
<a name="l00282"></a>00282   fread ( &amp;sintBad, <span class="keyword">sizeof</span> ( <span class="keywordtype">short</span> <span class="keywordtype">int</span> ), 1, fp );
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   fread ( &amp;sintBad, <span class="keyword">sizeof</span> ( <span class="keywordtype">short</span> <span class="keywordtype">int</span> ), 1, fp );
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   <span class="comment">// read image dimensions</span>
<a name="l00287"></a>00287   fread ( &amp;img-&gt;<a class="code" href="a00023_36f406959a34f391746e66bb8ee3e334.html#36f406959a34f391746e66bb8ee3e334">initWidth</a>, sizeof ( <span class="keywordtype">short</span> <span class="keywordtype">int</span> ), 1, fp );
<a name="l00288"></a>00288 
<a name="l00289"></a>00289   fread ( &amp;img-&gt;<a class="code" href="a00023_872de85785e03050a81a5c01e0ddd4a0.html#872de85785e03050a81a5c01e0ddd4a0">initHeight</a>, sizeof ( <span class="keywordtype">short</span> <span class="keywordtype">int</span> ), 1, fp );
<a name="l00290"></a>00290 
<a name="l00291"></a>00291   img-&gt;<a class="code" href="a00023_27ec986c52261757ad7e8a027b7154be.html#27ec986c52261757ad7e8a027b7154be">width</a> = img-&gt;<a class="code" href="a00023_36f406959a34f391746e66bb8ee3e334.html#36f406959a34f391746e66bb8ee3e334">initWidth</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293   img-&gt;<a class="code" href="a00023_d31f0d5dbf799da956b02123572e9920.html#d31f0d5dbf799da956b02123572e9920">height</a> = img-&gt;<a class="code" href="a00023_872de85785e03050a81a5c01e0ddd4a0.html#872de85785e03050a81a5c01e0ddd4a0">initHeight</a>;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295   img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a> = getPow2 ( img-&gt;<a class="code" href="a00023_36f406959a34f391746e66bb8ee3e334.html#36f406959a34f391746e66bb8ee3e334">initWidth</a> );
<a name="l00296"></a>00296 
<a name="l00297"></a>00297   img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a> = getPow2 ( img-&gt;<a class="code" href="a00023_872de85785e03050a81a5c01e0ddd4a0.html#872de85785e03050a81a5c01e0ddd4a0">initHeight</a> );
<a name="l00298"></a>00298 
<a name="l00299"></a>00299   <span class="comment">// read bit depth</span>
<a name="l00300"></a>00300   fread ( &amp;bitCount, <span class="keyword">sizeof</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ), 1, fp );
<a name="l00301"></a>00301 
<a name="l00302"></a>00302   <span class="comment">// read garbage</span>
<a name="l00303"></a>00303   fread ( &amp;ucharBad, <span class="keyword">sizeof</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ), 1, fp );
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="comment">// colormode -&gt; 3 = BGR, 4 = BGRA</span>
<a name="l00306"></a>00306   colorMode = bitCount / 8;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308   img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> = img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a> * img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a> * colorMode;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <span class="comment">// allocate memory for image data</span>
<a name="l00311"></a>00311   img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> = ( u32* ) malloc ( <span class="keyword">sizeof</span> ( u32 ) * img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> );
<a name="l00312"></a>00312 
<a name="l00313"></a>00313   <span class="comment">// read image data</span>
<a name="l00314"></a>00314   fread ( img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>, sizeof ( u32 ), img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a>, fp );
<a name="l00315"></a>00315 
<a name="l00316"></a>00316   <span class="comment">// change BGR to RGB</span>
<a name="l00317"></a>00317   <span class="keywordflow">for</span> ( imageIdx = 0; imageIdx &lt; img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a>; imageIdx += colorMode ) {
<a name="l00318"></a>00318     colorSwap = img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>[imageIdx];
<a name="l00319"></a>00319     img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>[imageIdx] = img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>[imageIdx+2];
<a name="l00320"></a>00320     img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>[imageIdx + 2] = colorSwap;
<a name="l00321"></a>00321   }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323   <span class="comment">// close the file</span>
<a name="l00324"></a>00324   fclose ( fp );
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 <span class="comment">// Bronx's jpeg loader. Broken atm mainly due to variable type conflicts/issues.</span>
<a name="l00328"></a>00328 <span class="comment">//Compiles fine though :S</span>
<a name="l00329"></a>00329 <span class="keyword">static</span> <span class="keywordtype">void</span> load_jpg ( <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <a class="code" href="a00023.html">Image</a> *img ) {
<a name="l00330"></a>00330 
<a name="l00331"></a>00331   <span class="keyword">struct </span>jpeg_decompress_struct cinfo;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333   <span class="comment">// open the image file</span>
<a name="l00334"></a>00334   FILE *fp;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336   <span class="keywordflow">if</span> ( ( fp = fopen ( filename, <span class="stringliteral">"rb"</span> ) ) == NULL )
<a name="l00337"></a>00337     <span class="keywordflow">return</span>;
<a name="l00338"></a>00338 
<a name="l00339"></a>00339   pspDebugScreenPrintf ( <span class="stringliteral">"Blah"</span> );
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   sceKernelDelayThread ( 10000 );
<a name="l00342"></a>00342 
<a name="l00343"></a>00343   <span class="comment">// Create an error manager</span>
<a name="l00344"></a>00344 
<a name="l00345"></a>00345   <span class="keyword">struct </span>jpeg_error_mgr jerr;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347   <span class="comment">// Make compression info object point to the error handler address</span>
<a name="l00348"></a>00348   cinfo.err = jpeg_std_error ( &amp;jerr );
<a name="l00349"></a>00349 
<a name="l00350"></a>00350   <span class="comment">// Init the decompression object</span>
<a name="l00351"></a>00351   jpeg_create_decompress ( &amp;cinfo );
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   <span class="comment">// Specify the data source (the image)</span>
<a name="l00354"></a>00354   jpeg_stdio_src ( &amp;cinfo, fp );
<a name="l00355"></a>00355 
<a name="l00356"></a>00356   <span class="comment">// Read in the header of the JPEG file</span>
<a name="l00357"></a>00357   jpeg_read_header ( &amp;cinfo, TRUE );
<a name="l00358"></a>00358 
<a name="l00359"></a>00359   <span class="comment">// Decompress the JPEG file with out compression info</span>
<a name="l00360"></a>00360   jpeg_start_decompress ( &amp;cinfo );
<a name="l00361"></a>00361 
<a name="l00362"></a>00362   <span class="comment">// Get image dimensions and row span to read in pixel data</span>
<a name="l00363"></a>00363   <span class="keywordtype">int</span> rowSpan = cinfo.image_width * cinfo.num_components;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   img-&gt;<a class="code" href="a00023_36f406959a34f391746e66bb8ee3e334.html#36f406959a34f391746e66bb8ee3e334">initWidth</a> = cinfo.image_width;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367   img-&gt;<a class="code" href="a00023_872de85785e03050a81a5c01e0ddd4a0.html#872de85785e03050a81a5c01e0ddd4a0">initHeight</a> = cinfo.image_height;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a> = getPow2 ( cinfo.image_width );
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a> = getPow2 ( cinfo.image_height );
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> = img-&gt;<a class="code" href="a00023_36f406959a34f391746e66bb8ee3e334.html#36f406959a34f391746e66bb8ee3e334">initWidth</a> * img-&gt;<a class="code" href="a00023_872de85785e03050a81a5c01e0ddd4a0.html#872de85785e03050a81a5c01e0ddd4a0">initHeight</a> * <span class="keyword">sizeof</span> ( u32 );
<a name="l00374"></a>00374 
<a name="l00375"></a>00375   <span class="comment">// Allocate memory for the pixel buffer</span>
<a name="l00376"></a>00376   img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> = ( u32* ) malloc ( img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> );
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   <span class="comment">// Create an array of row pointers</span>
<a name="l00379"></a>00379   u32* rowPtr = ( u32* ) malloc ( img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a> * sizeof ( u32 ) );
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   <span class="keywordtype">int</span> i;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383   <span class="keywordflow">for</span> ( i = 0; i &lt; img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a>; i++ )
<a name="l00384"></a>00384     rowPtr[i] = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ) img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>[i * rowSpan];
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="comment">// Extract all the pixel data</span>
<a name="l00387"></a>00387   <span class="keywordtype">int</span> rowsRead = 0;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389   while ( cinfo.output_scanline &lt; cinfo.output_height )
<a name="l00390"></a>00390     <span class="comment">// Read in the current row of pixels and increase the rowsRead count</span>
<a name="l00391"></a>00391     rowsRead += jpeg_read_scanlines ( &amp;cinfo, ( JSAMPARRAY ) &amp; rowPtr[rowsRead], cinfo.output_height - rowsRead );
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   free ( rowPtr );
<a name="l00394"></a>00394 
<a name="l00395"></a>00395   <span class="comment">// Finish decompressing the data</span>
<a name="l00396"></a>00396   jpeg_finish_decompress ( &amp;cinfo );
<a name="l00397"></a>00397 
<a name="l00398"></a>00398   <span class="comment">// Release all memory for reading and decoding the jpeg</span>
<a name="l00399"></a>00399   jpeg_destroy_decompress ( &amp;cinfo );
<a name="l00400"></a>00400 
<a name="l00401"></a>00401   fclose ( fp );
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="keyword">static</span> <span class="keywordtype">void</span> swizzle_image ( <a class="code" href="a00023.html">Image</a> *img ) {
<a name="l00405"></a>00405   <span class="comment">// Swizzle the texture</span>
<a name="l00406"></a>00406   <span class="keywordtype">int</span> rowblocks = ( ( img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a> * 4 ) / 16 );
<a name="l00407"></a>00407   <span class="keywordtype">int</span> rowblocks_add = ( rowblocks - 1 ) * 128;
<a name="l00408"></a>00408   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> block_address = 0;
<a name="l00409"></a>00409   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *src = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* ) img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411   <span class="keyword">static</span> u8 *t_data;
<a name="l00412"></a>00412   t_data = ( u8* ) malloc ( img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> );
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   <span class="keywordtype">int</span> j;
<a name="l00415"></a>00415   <span class="keywordflow">for</span> ( j = 0; j &lt; img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a>; j++, block_address += 16 ) {
<a name="l00416"></a>00416     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *block = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>* ) ( ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ) &amp; t_data[block_address] | 0x40000000 );
<a name="l00417"></a>00417     <span class="keywordtype">int</span> i;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="keywordflow">for</span> ( i = 0; i &lt; rowblocks; i++ ) {
<a name="l00420"></a>00420       *block++ = *src++;
<a name="l00421"></a>00421       *block++ = *src++;
<a name="l00422"></a>00422       *block++ = *src++;
<a name="l00423"></a>00423       *block++ = *src++;
<a name="l00424"></a>00424       block += 28;
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <span class="keywordflow">if</span> ( ( j&amp;0x7 ) == 0x7 )
<a name="l00428"></a>00428       block_address += rowblocks_add;
<a name="l00429"></a>00429   }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431   free ( img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> );
<a name="l00432"></a>00432 
<a name="l00433"></a>00433   <span class="keywordflow">if</span> ( img-&gt;<a class="code" href="a00023_3c281e0a073be19d113bfe90b6d70a6a.html#3c281e0a073be19d113bfe90b6d70a6a">location</a> )
<a name="l00434"></a>00434     img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> = ( u32* ) valloc ( img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> );
<a name="l00435"></a>00435   <span class="keywordflow">else</span>
<a name="l00436"></a>00436     img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> = ( u32* ) malloc ( img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> );
<a name="l00437"></a>00437 
<a name="l00438"></a>00438   <span class="comment">//img-&gt;data = (u32*)t_data;</span>
<a name="l00439"></a>00439   memcpy ( img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a>, t_data, img-&gt;<a class="code" href="a00023_d682bf1f61fc0ebb156a03a46d19a4c2.html#d682bf1f61fc0ebb156a03a46d19a4c2">totalSize</a> );
<a name="l00440"></a>00440 
<a name="l00441"></a>00441   free ( t_data );
<a name="l00442"></a>00442 
<a name="l00443"></a>00443   sceKernelDcacheWritebackAll();
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a><a class="code" href="a00044_gd56c2371230a096261f39b0da4e7b5ef.html#gd56c2371230a096261f39b0da4e7b5ef">00446</a> <a class="code" href="a00023.html">Image</a> *<a class="code" href="a00044_gd56c2371230a096261f39b0da4e7b5ef.html#gd56c2371230a096261f39b0da4e7b5ef">load_image</a> ( <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> location ) {
<a name="l00447"></a>00447   <span class="comment">// Allocate some memory for our image</span>
<a name="l00448"></a>00448   <a class="code" href="a00023.html">Image</a> *img = ( <a class="code" href="a00023.html">Image</a>* ) malloc ( <span class="keyword">sizeof</span> ( <a class="code" href="a00023.html">Image</a> ) );
<a name="l00449"></a>00449   img-&gt;<a class="code" href="a00023_3c281e0a073be19d113bfe90b6d70a6a.html#3c281e0a073be19d113bfe90b6d70a6a">location</a> = location;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451   <span class="comment">// Determine the filetype</span>
<a name="l00452"></a>00452 
<a name="l00453"></a>00453   <span class="keyword">const</span> <span class="keywordtype">char</span> *suffix = strrchr ( filename, <span class="charliteral">'.'</span> );
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   <span class="comment">// Load image by it's filetype</span>
<a name="l00456"></a>00456   <span class="keywordflow">if</span> ( strcmp ( suffix, <span class="stringliteral">".png"</span> ) == 0 )
<a name="l00457"></a>00457     load_png ( filename, img );
<a name="l00458"></a>00458 
<a name="l00459"></a>00459   <span class="comment">//else if(strcmp(suffix,".bmp") == 0)</span>
<a name="l00460"></a>00460   <span class="comment">// bitmap file loader goes here</span>
<a name="l00461"></a>00461   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp ( suffix, <span class="stringliteral">".tga"</span> ) == 0 )
<a name="l00462"></a>00462     load_tga ( filename, img );
<a name="l00463"></a>00463   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp ( suffix, <span class="stringliteral">".jpg"</span> ) == 0 )
<a name="l00464"></a>00464     load_jpg ( filename, img );
<a name="l00465"></a>00465 
<a name="l00466"></a>00466   sceKernelDcacheWritebackAll();
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   <span class="comment">// Swizzle the texture</span>
<a name="l00469"></a>00469   swizzle_image ( img );
<a name="l00470"></a>00470 
<a name="l00471"></a>00471   img-&gt;<a class="code" href="a00023_b5be3f17a7d1c8edf65cca973f2dc48f.html#b5be3f17a7d1c8edf65cca973f2dc48f">x</a> = 0.0f;
<a name="l00472"></a>00472   img-&gt;<a class="code" href="a00023_1ff7add3500ec4d6e3efc08188a64a59.html#1ff7add3500ec4d6e3efc08188a64a59">y</a> = 0.0f;
<a name="l00473"></a>00473   img-&gt;<a class="code" href="a00023_6830290a583187b4451c14bf21fd931e.html#6830290a583187b4451c14bf21fd931e">startX</a> = 0.0f;
<a name="l00474"></a>00474   img-&gt;<a class="code" href="a00023_c0e0af4fbd650f7e4375113d20889ade.html#c0e0af4fbd650f7e4375113d20889ade">startY</a> = 0.0f;
<a name="l00475"></a>00475   img-&gt;<a class="code" href="a00023_341229237f7f8a6001e3132c89c10bb4.html#341229237f7f8a6001e3132c89c10bb4">endX</a> = img-&gt;<a class="code" href="a00023_27ec986c52261757ad7e8a027b7154be.html#27ec986c52261757ad7e8a027b7154be">width</a>;
<a name="l00476"></a>00476   img-&gt;<a class="code" href="a00023_6b6186f137c1851ecd4939cccc0ec345.html#6b6186f137c1851ecd4939cccc0ec345">endY</a> = img-&gt;<a class="code" href="a00023_d31f0d5dbf799da956b02123572e9920.html#d31f0d5dbf799da956b02123572e9920">height</a>;
<a name="l00477"></a>00477   img-&gt;<a class="code" href="a00023_c309847258f6a714ab9cd5d9fe39db11.html#c309847258f6a714ab9cd5d9fe39db11">angle</a> = 0.0f;
<a name="l00478"></a>00478   img-&gt;<a class="code" href="a00023_2ddce309364cb64cfa2fa5f6540b2072.html#2ddce309364cb64cfa2fa5f6540b2072">centerX</a> = 0.0f;
<a name="l00479"></a>00479   img-&gt;<a class="code" href="a00023_53153de0cbd380c8ec93b0f143382869.html#53153de0cbd380c8ec93b0f143382869">centerY</a> = 0.0f;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <span class="comment">// Clear bad data from the cache</span>
<a name="l00482"></a>00482   sceKernelDcacheWritebackAll();
<a name="l00483"></a>00483 
<a name="l00484"></a>00484   <span class="keywordflow">return</span> img;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="a00044_gabd2ead8f3f86057db425d022aa1d581.html#gabd2ead8f3f86057db425d022aa1d581">00487</a> <span class="keywordtype">void</span> <a class="code" href="a00044_gabd2ead8f3f86057db425d022aa1d581.html#gabd2ead8f3f86057db425d022aa1d581">unload_image</a> ( <a class="code" href="a00023.html">Image</a> *img ) {
<a name="l00488"></a>00488   <span class="keywordflow">if</span> ( img-&gt;<a class="code" href="a00023_3c281e0a073be19d113bfe90b6d70a6a.html#3c281e0a073be19d113bfe90b6d70a6a">location</a> )
<a name="l00489"></a>00489     vfree ( img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> );
<a name="l00490"></a>00490   <span class="keywordflow">else</span>
<a name="l00491"></a>00491     free ( img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> );
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   free ( img );
<a name="l00494"></a>00494 }
<a name="l00495"></a>00495 
<a name="l00496"></a><a class="code" href="a00044_g0d59274c2da141d972ad73707c6004e8.html#g0d59274c2da141d972ad73707c6004e8">00496</a> <span class="keywordtype">void</span> <a class="code" href="a00044_g0d59274c2da141d972ad73707c6004e8.html#g0d59274c2da141d972ad73707c6004e8">draw_image</a> ( <a class="code" href="a00023.html">Image</a> *img ) {
<a name="l00497"></a>00497   <span class="keywordflow">if</span> ( !img-&gt;<a class="code" href="a00023_27ec986c52261757ad7e8a027b7154be.html#27ec986c52261757ad7e8a027b7154be">width</a> || !img-&gt;<a class="code" href="a00023_341229237f7f8a6001e3132c89c10bb4.html#341229237f7f8a6001e3132c89c10bb4">endX</a> )
<a name="l00498"></a>00498     <span class="keywordflow">return</span>;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500   <span class="keywordtype">float</span> u_end = img-&gt;<a class="code" href="a00023_341229237f7f8a6001e3132c89c10bb4.html#341229237f7f8a6001e3132c89c10bb4">endX</a> - img-&gt;<a class="code" href="a00023_6830290a583187b4451c14bf21fd931e.html#6830290a583187b4451c14bf21fd931e">startX</a>;
<a name="l00501"></a>00501   <span class="keywordtype">float</span> u_width = img-&gt;<a class="code" href="a00023_341229237f7f8a6001e3132c89c10bb4.html#341229237f7f8a6001e3132c89c10bb4">endX</a> / ( img-&gt;<a class="code" href="a00023_27ec986c52261757ad7e8a027b7154be.html#27ec986c52261757ad7e8a027b7154be">width</a> / 64.0f );
<a name="l00502"></a>00502   <span class="keywordtype">float</span> cur_u = img-&gt;<a class="code" href="a00023_6830290a583187b4451c14bf21fd931e.html#6830290a583187b4451c14bf21fd931e">startX</a>;
<a name="l00503"></a>00503   <span class="keywordtype">float</span> cur_x = 0.0f;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505   <span class="comment">// Some matrix stuff to position the matrix and rotate it. Extremely fast though, since it uses vfpu to get the job done</span>
<a name="l00506"></a>00506   <a class="code" href="a00050_g53f36986abb319a887797f77a222f72e.html#g53f36986abb319a887797f77a222f72e">vfpu_identity_m</a> ( &amp;m_ortho_view );
<a name="l00507"></a>00507   <a class="code" href="a00050_g362eb813d0d7755665991083cdb9d22c.html#g362eb813d0d7755665991083cdb9d22c">vfpu_translate_m</a> ( &amp;m_ortho_view, img-&gt;<a class="code" href="a00023_b5be3f17a7d1c8edf65cca973f2dc48f.html#b5be3f17a7d1c8edf65cca973f2dc48f">x</a>, img-&gt;<a class="code" href="a00023_1ff7add3500ec4d6e3efc08188a64a59.html#1ff7add3500ec4d6e3efc08188a64a59">y</a>, 0.0f );
<a name="l00508"></a>00508   
<a name="l00509"></a>00509   <a class="code" href="a00050_g53f36986abb319a887797f77a222f72e.html#g53f36986abb319a887797f77a222f72e">vfpu_identity_m</a> ( &amp;m_ortho_model );
<a name="l00510"></a>00510   <a class="code" href="a00050_gf5492cceaa56f0e3240485d5591c1b50.html#gf5492cceaa56f0e3240485d5591c1b50">vfpu_rotateZ_m</a> ( &amp;m_ortho_model, img-&gt;<a class="code" href="a00023_c309847258f6a714ab9cd5d9fe39db11.html#c309847258f6a714ab9cd5d9fe39db11">angle</a> );
<a name="l00511"></a>00511   <a class="code" href="a00050_g362eb813d0d7755665991083cdb9d22c.html#g362eb813d0d7755665991083cdb9d22c">vfpu_translate_m</a> ( &amp;m_ortho_model, img-&gt;<a class="code" href="a00023_2ddce309364cb64cfa2fa5f6540b2072.html#2ddce309364cb64cfa2fa5f6540b2072">centerX</a>, img-&gt;<a class="code" href="a00023_53153de0cbd380c8ec93b0f143382869.html#53153de0cbd380c8ec93b0f143382869">centerY</a>, 0.0f );
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   sceGuSetMatrix ( GU_PROJECTION, &amp;m_ortho );
<a name="l00514"></a>00514   sceGuSetMatrix ( GU_VIEW, &amp;m_ortho_view );
<a name="l00515"></a>00515   sceGuSetMatrix ( GU_MODEL, &amp;m_ortho_model );
<a name="l00516"></a>00516 
<a name="l00517"></a>00517   <span class="keywordtype">float</span> u = 1.0f / ( ( float ) img-&gt;<a class="code" href="a00023_36f406959a34f391746e66bb8ee3e334.html#36f406959a34f391746e66bb8ee3e334">initWidth</a> );
<a name="l00518"></a>00518   <span class="keywordtype">float</span> v = 1.0f / ( ( float ) img-&gt;<a class="code" href="a00023_872de85785e03050a81a5c01e0ddd4a0.html#872de85785e03050a81a5c01e0ddd4a0">initHeight</a> );
<a name="l00519"></a>00519   sceGuTexScale ( u, v );
<a name="l00520"></a>00520 
<a name="l00521"></a>00521   <span class="comment">// Set texture</span>
<a name="l00522"></a>00522   sceGuTexImage ( 0, img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a>, img-&gt;<a class="code" href="a00023_a3f17ae35d35eea4bd5d5a723008e60b.html#a3f17ae35d35eea4bd5d5a723008e60b">realHeight</a>, img-&gt;<a class="code" href="a00023_8c157177016cbc2d4ec7d2661c865cee.html#8c157177016cbc2d4ec7d2661c865cee">realWidth</a>, ( <span class="keywordtype">void</span>* ) img-&gt;<a class="code" href="a00023_50f3438dafa4842dfe63a01e560421b6.html#50f3438dafa4842dfe63a01e560421b6">data</a> );
<a name="l00523"></a>00523 
<a name="l00524"></a>00524   <span class="keywordflow">while</span> ( cur_x != img-&gt;<a class="code" href="a00023_27ec986c52261757ad7e8a027b7154be.html#27ec986c52261757ad7e8a027b7154be">width</a> ) {
<a name="l00525"></a>00525     <a class="code" href="a00028.html">TP_Vertex_3D</a>* vertices = ( <a class="code" href="a00028.html">TP_Vertex_3D</a>* ) sceGuGetMemory ( 4 * <span class="keyword">sizeof</span> ( <a class="code" href="a00028.html">TP_Vertex_3D</a> ) );
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     vertices[0].<a class="code" href="a00028_0c524a7c2856bff828b3aea936032f25.html#0c524a7c2856bff828b3aea936032f25">u</a> = cur_u;
<a name="l00528"></a>00528     vertices[0].<a class="code" href="a00028_e3e893e5718b694cf142b7015df23a7c.html#e3e893e5718b694cf142b7015df23a7c">v</a> = img-&gt;<a class="code" href="a00023_c0e0af4fbd650f7e4375113d20889ade.html#c0e0af4fbd650f7e4375113d20889ade">startY</a>;
<a name="l00529"></a>00529     vertices[0].<a class="code" href="a00028_dca6c12ffc57732d01a1a35fa9242ed7.html#dca6c12ffc57732d01a1a35fa9242ed7">x</a> = cur_x;
<a name="l00530"></a>00530     vertices[0].<a class="code" href="a00028_90ecb69a541c0ac907a83493baf47e2b.html#90ecb69a541c0ac907a83493baf47e2b">y</a> = 0.0f;
<a name="l00531"></a>00531     vertices[0].<a class="code" href="a00028_37042313a6276ecb150c747a4df5fb79.html#37042313a6276ecb150c747a4df5fb79">z</a> = 0.0f;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     vertices[2].<a class="code" href="a00028_0c524a7c2856bff828b3aea936032f25.html#0c524a7c2856bff828b3aea936032f25">u</a> = cur_u;
<a name="l00534"></a>00534     vertices[2].<a class="code" href="a00028_e3e893e5718b694cf142b7015df23a7c.html#e3e893e5718b694cf142b7015df23a7c">v</a> = img-&gt;<a class="code" href="a00023_6b6186f137c1851ecd4939cccc0ec345.html#6b6186f137c1851ecd4939cccc0ec345">endY</a>;
<a name="l00535"></a>00535     vertices[2].<a class="code" href="a00028_dca6c12ffc57732d01a1a35fa9242ed7.html#dca6c12ffc57732d01a1a35fa9242ed7">x</a> = cur_x;
<a name="l00536"></a>00536     vertices[2].<a class="code" href="a00028_90ecb69a541c0ac907a83493baf47e2b.html#90ecb69a541c0ac907a83493baf47e2b">y</a> = img-&gt;<a class="code" href="a00023_d31f0d5dbf799da956b02123572e9920.html#d31f0d5dbf799da956b02123572e9920">height</a>;
<a name="l00537"></a>00537     vertices[2].<a class="code" href="a00028_37042313a6276ecb150c747a4df5fb79.html#37042313a6276ecb150c747a4df5fb79">z</a> = 0.0f;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     cur_u += u_width;
<a name="l00540"></a>00540     cur_x += 64.0f;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordflow">if</span> ( cur_x &gt; img-&gt;<a class="code" href="a00023_27ec986c52261757ad7e8a027b7154be.html#27ec986c52261757ad7e8a027b7154be">width</a> ) {
<a name="l00543"></a>00543       cur_x = img-&gt;<a class="code" href="a00023_27ec986c52261757ad7e8a027b7154be.html#27ec986c52261757ad7e8a027b7154be">width</a>;
<a name="l00544"></a>00544       cur_u = u_end;
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     vertices[1].<a class="code" href="a00028_0c524a7c2856bff828b3aea936032f25.html#0c524a7c2856bff828b3aea936032f25">u</a> = cur_u;
<a name="l00548"></a>00548     vertices[1].<a class="code" href="a00028_e3e893e5718b694cf142b7015df23a7c.html#e3e893e5718b694cf142b7015df23a7c">v</a> = img-&gt;<a class="code" href="a00023_c0e0af4fbd650f7e4375113d20889ade.html#c0e0af4fbd650f7e4375113d20889ade">startY</a>;
<a name="l00549"></a>00549     vertices[1].<a class="code" href="a00028_dca6c12ffc57732d01a1a35fa9242ed7.html#dca6c12ffc57732d01a1a35fa9242ed7">x</a> = cur_x;
<a name="l00550"></a>00550     vertices[1].<a class="code" href="a00028_90ecb69a541c0ac907a83493baf47e2b.html#90ecb69a541c0ac907a83493baf47e2b">y</a> = 0.0f;
<a name="l00551"></a>00551     vertices[1].<a class="code" href="a00028_37042313a6276ecb150c747a4df5fb79.html#37042313a6276ecb150c747a4df5fb79">z</a> = 0.0f;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     vertices[3].<a class="code" href="a00028_0c524a7c2856bff828b3aea936032f25.html#0c524a7c2856bff828b3aea936032f25">u</a> = cur_u;
<a name="l00554"></a>00554     vertices[3].<a class="code" href="a00028_e3e893e5718b694cf142b7015df23a7c.html#e3e893e5718b694cf142b7015df23a7c">v</a> = img-&gt;<a class="code" href="a00023_6b6186f137c1851ecd4939cccc0ec345.html#6b6186f137c1851ecd4939cccc0ec345">endY</a>;
<a name="l00555"></a>00555     vertices[3].<a class="code" href="a00028_dca6c12ffc57732d01a1a35fa9242ed7.html#dca6c12ffc57732d01a1a35fa9242ed7">x</a> = cur_x;
<a name="l00556"></a>00556     vertices[3].<a class="code" href="a00028_90ecb69a541c0ac907a83493baf47e2b.html#90ecb69a541c0ac907a83493baf47e2b">y</a> = img-&gt;<a class="code" href="a00023_d31f0d5dbf799da956b02123572e9920.html#d31f0d5dbf799da956b02123572e9920">height</a>;
<a name="l00557"></a>00557     vertices[3].<a class="code" href="a00028_37042313a6276ecb150c747a4df5fb79.html#37042313a6276ecb150c747a4df5fb79">z</a> = 0.0f;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     sceGuDrawArray ( GU_TRIANGLE_STRIP, GU_TEXTURE_32BITF | GU_VERTEX_32BITF | GU_TRANSFORM_3D, 4, 0, vertices );
<a name="l00560"></a>00560   }
<a name="l00561"></a>00561   sceGuTexScale ( 1.0f, 1.0f );
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a><a class="code" href="a00044_g197281537137378d16f9557ffa99cdb8.html#g197281537137378d16f9557ffa99cdb8">00564</a> <span class="keywordtype">void</span> <a class="code" href="a00044_g197281537137378d16f9557ffa99cdb8.html#g197281537137378d16f9557ffa99cdb8">set_linear_filter</a> ( <span class="keywordtype">short</span> state ) {
<a name="l00565"></a>00565   <span class="keywordflow">if</span> ( drawingStarted ) {
<a name="l00566"></a>00566     sceGuTexFilter ( state, state );
<a name="l00567"></a>00567     <span class="keywordflow">return</span>;
<a name="l00568"></a>00568   }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570   sceGuStart ( GU_DIRECT, DList );
<a name="l00571"></a>00571   sceGuTexFilter ( state, state );
<a name="l00572"></a>00572   sceGuFinish();
<a name="l00573"></a>00573   sceGuSync ( 0, 0 );
<a name="l00574"></a>00574 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Mar 20 23:01:06 2007 for vLib by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
